box: wercker/ubuntu12.04-nodejs0.10
packages:
    - firefox
build:
  steps:
    # install dependencies and cache them to increase build speed
    - bundle-install

    - script:
       name: install texlive-base
       code: |-
          sudo apt-get update -qq
          sudo apt-get install texlive-base

    # http://blog.wercker.com/2013/11/28/django-selenium.html
    - script:
        name: Enable virtual display
        code: |-
          # Start xvfb which gives the context an virtual display
          # which is required for tests that require an GUI
          export DISPLAY=:99.0
          start-stop-daemon --start --quiet --pidfile /tmp/xvfb_99.pid --make-pidfile --background --exec /usr/bin/Xvfb -- :99 -screen 0 1024x768x24 -ac +extension GLX +render -noreset
          # Give xvfb time to start. 3 seconds is the default for all xvfb-run commands.
          sleep 3

    - install-packages:
        packages: firefox

    - npm-install
    - npm-test

    - script:
        name: update webdriver
        code: |
          $(npm bin)/webdriver-manager update

    - script:
        name: run e2e-tests
        code: |-
          (($(npm bin)/webdriver-manager start &) &)
          ((npm start &) &)
          #wait for app and webdriver session to start
          sleep 10
          $(npm bin)/protractor tests/e2e/config.js

    # A custom script step, name value is used in the UI
    # and the code value contains the command that get executed
    - script:
        name: echo nodejs information
        code: |
          echo "node version $(node -v) running"
          echo "npm version $(npm -v) running"

